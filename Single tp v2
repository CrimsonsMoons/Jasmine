local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local HRP = Character:WaitForChild("HumanoidRootPart")

local checkpointsFolder = workspace.Islands["Training Island"]["Outdoor Arena"].DynamicArena
    ._LAYOUT.CheckpointActivity.Routes.Checkpoints

-- Get the player's owned UUID NPC
local function getOwnedUUIDModel()
    local folder = workspace.Islands["Training Island"]

    for _, model in ipairs(folder:GetChildren()) do
        if model:IsA("Model") and model:FindFirstChild("Humanoid") then
            local humanoid = model:FindFirstChild("Humanoid")
            local root = model:FindFirstChild("HumanoidRootPart") or model:FindFirstChildWhichIsA("BasePart")
            local owner = humanoid:GetAttribute("owner")

            if root and owner == LocalPlayer.Name then
                model.PrimaryPart = root

                -- Unanchor all parts to allow movement
                for _, part in ipairs(model:GetDescendants()) do
                    if part:IsA("BasePart") then
                        part.Anchored = false
                    end
                end

                return model
            end
        end
    end

    return nil
end

-- GUI setup
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "TeleportToggleGui"
screenGui.Parent = PlayerGui
screenGui.ResetOnSpawn = false

local button = Instance.new("TextButton")
button.Size = UDim2.new(0, 140, 0, 50)
button.Position = UDim2.new(0, 20, 0, 20)
button.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
button.TextColor3 = Color3.new(1, 1, 1)
button.Font = Enum.Font.SourceSansBold
button.TextSize = 24
button.Text = "Start Teleport"
button.Parent = screenGui

-- Teleport logic
local running = false
local teleportTask

local function teleportToCheckpoint(checkpointName, uuidModel)
    local checkpoint = checkpointsFolder:FindFirstChild(checkpointName)
    if not checkpoint or not checkpoint:IsA("BasePart") then return end

    -- Teleport player
    HRP.CFrame = checkpoint.CFrame + Vector3.new(2, 3, 0)

    -- Teleport UUID model if valid
    if uuidModel and uuidModel.PrimaryPart then
        uuidModel:SetPrimaryPartCFrame(checkpoint.CFrame + Vector3.new(-2, 3, 0))
    end
end

local order = {"1", "2", "3", "4"}

local function startLoop()
    teleportTask = task.spawn(function()
        local uuidModel = getOwnedUUIDModel()

        if not uuidModel then
            warn("No UUID NPC with 'owner' = " .. LocalPlayer.Name)
        end

        while running do
            for i, checkpoint in ipairs(order) do
                if not running then break end
                teleportToCheckpoint(checkpoint, uuidModel)

                local waitTime = (i == 1 or i == 3 or i == 4) and 1 or 0.8
                task.wait(waitTime)
            end
        end
    end)
end

button.MouseButton1Click:Connect(function()
    running = not running
    button.Text = running and "Stop Teleport" or "Start Teleport"

    if running then
        startLoop()
    end
end)
