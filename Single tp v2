local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local HRP = Character:WaitForChild("HumanoidRootPart")

local checkpointsFolder = workspace.Islands["Training Island"]["Outdoor Arena"].DynamicArena
    ._LAYOUT.CheckpointActivity.Routes.Checkpoints

-- Get NPCs owned by the player
local function getOwnedNPC()
    local folder = workspace.Islands["Training Island"]
    for _, model in ipairs(folder:GetChildren()) do
        if model:IsA("Model") and model:FindFirstChild("Humanoid") then
            local humanoid = model:FindFirstChild("Humanoid")
            if humanoid:GetAttribute("owner") == LocalPlayer.Name then
                local root = model:FindFirstChild("HumanoidRootPart") or model:FindFirstChildWhichIsA("BasePart")
                if root then
                    model.PrimaryPart = root
                    return model
                end
            end
        end
    end
    return nil
end

-- GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "TeleportToggleGui"
screenGui.Parent = PlayerGui
screenGui.ResetOnSpawn = false

local button = Instance.new("TextButton")
button.Size = UDim2.new(0, 140, 0, 50)
button.Position = UDim2.new(0, 20, 0, 20)
button.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
button.TextColor3 = Color3.new(1, 1, 1)
button.Font = Enum.Font.SourceSansBold
button.TextSize = 24
button.Text = "Start Teleport"
button.Parent = screenGui

-- Teleport logic
local running = false
local teleportTask

local function teleportToCheckpoint(checkpointName, npc)
    local checkpoint = checkpointsFolder:FindFirstChild(checkpointName)
    if not checkpoint or not checkpoint:IsA("BasePart") then return end

    -- Teleport player
    HRP.CFrame = checkpoint.CFrame + Vector3.new(2, 3, 0)

    -- Teleport NPC if valid
    if npc and npc.PrimaryPart then
        npc:SetPrimaryPartCFrame(checkpoint.CFrame + Vector3.new(-2, 3, 0))
    end
end

local order = {"1", "2", "3", "4"}

local function startLoop()
    teleportTask = task.spawn(function()
        local npc = getOwnedNPC()
        while running do
            for i, checkpoint in ipairs(order) do
                if not running then break end
                teleportToCheckpoint(checkpoint, npc)

                local waitTime = 0.8
                if i == 1 or i == 3 or i == 4 then
                    waitTime = 1
                end
                task.wait(waitTime)
            end
        end
    end)
end

button.MouseButton1Click:Connect(function()
    running = not running
    button.Text = running and "Stop Teleport" or "Start Teleport"

    if running then
        startLoop()
    end
end)
