local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local hrp = Character:WaitForChild("HumanoidRootPart")

----- Reconnect HRP on respawn
LocalPlayer.CharacterAdded:Connect(function(char)
    Character = char
    hrp = Character:WaitForChild("HumanoidRootPart")
end)

local uuids = {
    "{60f828f4-a916-4262-842e-7ddc49e07ad9}",
    "{c5769905-aecf-4d7a-ada9-064802b0cae9}",
    "{d2227f02-c482-4911-b201-7e842b31c47c}",
    "{6b019e60-21c6-4536-9a06-4cbfee80d88f}",
    "{12916ad6-7fd9-46d5-8bc1-e69671249721}",
}

local function isUUID(str)
    return string.match(str, "^%b{}$") ~= nil
end

local function getNPCs()
    local folder = workspace.Islands["Training Island"]
    local npcList = {}

    for _, uuid in ipairs(uuids) do
        local model = folder:FindFirstChild(uuid)
        if model and model:IsA("Model") then
            local root = model:FindFirstChild("HumanoidRootPart") or model:FindFirstChildWhichIsA("BasePart")
            if root then
                model.PrimaryPart = root
                table.insert(npcList, model)
            end
        end
    end

    for _, model in ipairs(folder:GetDescendants()) do
        if model:IsA("Model") and isUUID(model.Name) and not table.find(uuids, model.Name) then
            if model:FindFirstChildWhichIsA("Humanoid") then
                local root = model:FindFirstChild("HumanoidRootPart") or model:FindFirstChildWhichIsA("BasePart")
                if root then
                    model.PrimaryPart = root
                    table.insert(npcList, model)
                end
            end
        end
    end

    return npcList
end

-- ðŸ”¹ Tween helper
local function tweenTo(part, targetCFrame, time)
    if not part or not part.Parent then return end
    local tween = TweenService:Create(
        part,
        TweenInfo.new(time, Enum.EasingStyle.Linear),
        { CFrame = targetCFrame }
    )
    tween:Play()
end

local jumpRunning = false
local jumpTask

local function freezeJumpLoop(npcs)
    if jumpRunning then return end
    jumpRunning = true
    jumpTask = task.spawn(function()
        while jumpRunning do
            local char = LocalPlayer.Character
            if char then
                local humanoid = char:FindFirstChildWhichIsA("Humanoid")
                local hrp = char:FindFirstChild("HumanoidRootPart")
                if humanoid and hrp then
                    humanoid.Jump = true
                    humanoid.PlatformStand = true
                    hrp.Anchored = true
                end
            end

            for _, npc in ipairs(npcs) do
                local humanoid = npc:FindFirstChildWhichIsA("Humanoid")
                local root = npc.PrimaryPart
                if humanoid and root then
                    humanoid.Jump = true
                    humanoid.PlatformStand = true
                    root.Anchored = true
                end
            end

            task.wait(0.1)
        end
    end)
end

local function unfreezeJumpLoop(npcs)
    jumpRunning = false
    if jumpTask then
        task.cancel(jumpTask)
        jumpTask = nil
    end

    local char = LocalPlayer.Character
    if char then
        local humanoid = char:FindFirstChildWhichIsA("Humanoid")
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if humanoid and hrp then
            humanoid.PlatformStand = false
            hrp.Anchored = false
        end
    end

    for _, npc in ipairs(npcs) do
        local humanoid = npc:FindFirstChildWhichIsA("Humanoid")
        local root = npc.PrimaryPart
        if humanoid and root then
            humanoid.PlatformStand = false
            root.Anchored = false
        end
    end
end

local function workspaceHasImmediatePartNamedPart()
    for _, child in ipairs(workspace:GetChildren()) do
        if child.Name == "Part" then
            return true
        end
    end
    return false
end

local running = false
local teleportTask

local function teleportToPart(npcs)
    if not workspaceHasImmediatePartNamedPart() then
        local args = {
            [1] = "TriggerInteractable",
            [2] = workspace.Islands["Training Island"].CrossCountry.CheckpointActivity
        }

        local events = game:GetService("ReplicatedStorage")
            .Communication.Events:GetChildren()[37]

        if events then
            events:FireServer(unpack(args))
        end
        return
    end

    local targetPart = workspace:FindFirstChild("Part")
    if not targetPart or not targetPart:IsA("BasePart") then return end

    local char = LocalPlayer.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")

    local duration = 0.6

    if hrp then
        tweenTo(hrp, targetPart.CFrame + Vector3.new(2, 3, 0), duration)
    end

    for _, npc in ipairs(npcs) do
        if npc.PrimaryPart then
            tweenTo(npc.PrimaryPart, targetPart.CFrame + Vector3.new(-2, 3, 0), duration)
        end
    end
end

local function startLoop()
    teleportTask = task.spawn(function()
        local npcs = getNPCs()
        freezeJumpLoop(npcs)
        while running do
            teleportToPart(npcs)
            task.wait(1.7)
        end
        unfreezeJumpLoop(npcs)
    end)
end

-- GUI
local screenGui = Instance.new("ScreenGui", PlayerGui)
screenGui.Name = "TeleportToggleGui"
screenGui.ResetOnSpawn = false

local button = Instance.new("TextButton")
button.Size = UDim2.new(0, 160, 0, 50)
button.Position = UDim2.new(0, 20, 0, 20)
button.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
button.TextColor3 = Color3.new(1, 1, 1)
button.Font = Enum.Font.SourceSansBold
button.TextSize = 24
button.Text = "Start Teleport"
button.Parent = screenGui

button.MouseButton1Click:Connect(function()
    running = not running
    if running then
        button.Text = "Stop Teleport"
        startLoop()
    else
        button.Text = "Start Teleport"
        if teleportTask then
            task.cancel(teleportTask)
            teleportTask = nil
        end
        unfreezeJumpLoop(getNPCs())
    end
end)
