--// Checkpoint Tween Runner (FOR YOUR OWN GAME)
-- Put this LocalScript in StarterPlayerScripts
-- Requires: workspace.Checkpoints folder with checkpoint Parts (CP1, CP2, ...)

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local CollectionService = game:GetService("CollectionService")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

local CHECKPOINT_FOLDER_NAME = "Checkpoints"
local NPC_TAG = "RunnerNPC"

-- Movement tuning
local TWEEN_TIME_PER_STUD = 0.05      -- smaller = faster
local MIN_TWEEN_TIME = 0.35
local MAX_TWEEN_TIME = 3.0
local PLAYER_OFFSET = Vector3.new(2, 3, 0)
local NPC_OFFSET    = Vector3.new(-2, 3, 0)

-- State
local running = false
local loopTask: thread? = nil
local activeTweens = {} :: { [Instance]: Tween }

-- Character refs
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()

local function getHRP(char: Model)
	return char and char:FindFirstChild("HumanoidRootPart")
end

local function getHumanoid(char: Model)
	return char and char:FindFirstChildWhichIsA("Humanoid")
end

-- Reconnect on respawn
LocalPlayer.CharacterAdded:Connect(function(char)
	Character = char
end)

--// Utility: cancel active tween for a part
local function cancelTween(part: Instance)
	local t = activeTweens[part]
	if t then
		pcall(function() t:Cancel() end)
		activeTweens[part] = nil
	end
end

--// Tween a BasePart to CFrame
local function tweenPartTo(part: BasePart, goalCFrame: CFrame, duration: number)
	if not part or not part.Parent then return end

	cancelTween(part)

	local info = TweenInfo.new(
		duration,
		Enum.EasingStyle.Quad,
		Enum.EasingDirection.Out
	)

	local tween = TweenService:Create(part, info, { CFrame = goalCFrame })
	activeTweens[part] = tween
	tween:Play()

	-- Cleanup on finish
	tween.Completed:Connect(function()
		if activeTweens[part] == tween then
			activeTweens[part] = nil
		end
	end)

	return tween
end

--// Compute tween time based on distance
local function timeForDistance(fromPos: Vector3, toPos: Vector3)
	local dist = (toPos - fromPos).Magnitude
	local t = dist * TWEEN_TIME_PER_STUD
	if t < MIN_TWEEN_TIME then t = MIN_TWEEN_TIME end
	if t > MAX_TWEEN_TIME then t = MAX_TWEEN_TIME end
	return t
end

--// Get checkpoints sorted
local function getCheckpoints(): { BasePart }
	local folder = workspace:FindFirstChild(CHECKPOINT_FOLDER_NAME)
	if not folder then return {} end

	local parts = {}
	for _, obj in ipairs(folder:GetChildren()) do
		if obj:IsA("BasePart") then
			table.insert(parts, obj)
		end
	end

	table.sort(parts, function(a, b)
		local ao = a:GetAttribute("Order")
		local bo = b:GetAttribute("Order")
		if typeof(ao) == "number" and typeof(bo) == "number" then
			return ao < bo
		end

		-- Fallback: sort by trailing number in name (CP1, CP2, ...)
		local an = tonumber((a.Name:match("(%d+)$")))
		local bn = tonumber((b.Name:match("(%d+)$")))
		if an and bn then
			return an < bn
		end

		return a.Name < b.Name
	end)

	return parts
end

--// Get tagged NPC models
local function getNPCs(): { Model }
	local out = {}
	for _, inst in ipairs(CollectionService:GetTagged(NPC_TAG)) do
		if inst:IsA("Model") and inst.Parent then
			local pp = inst.PrimaryPart
				or inst:FindFirstChild("HumanoidRootPart")
				or inst:FindFirstChildWhichIsA("BasePart")

			if pp and pp:IsA("BasePart") then
				inst.PrimaryPart = pp
				table.insert(out, inst)
			end
		end
	end
	return out
end

--// Safe "lock" so tween doesn't get yanked by physics while running (your own game)
local function lockModel(model: Model, locked: boolean)
	local hum = model:FindFirstChildWhichIsA("Humanoid")
	local pp = model.PrimaryPart or model:FindFirstChild("HumanoidRootPart")
	if not pp or not pp:IsA("BasePart") then return end

	if locked then
		if hum then hum.PlatformStand = true end
		pp.Anchored = true
	else
		if hum then hum.PlatformStand = false end
		pp.Anchored = false
	end
end

local function stopAllTweensAndUnlock()
	-- cancel tweens
	for inst, _ in pairs(activeTweens) do
		cancelTween(inst)
	end

	-- unlock player
	local char = LocalPlayer.Character
	if char then lockModel(char, false) end

	-- unlock NPCs
	for _, npc in ipairs(getNPCs()) do
		lockModel(npc, false)
	end
end

--// Main loop: tween through checkpoints
local function runLoop()
	local checkpoints = getCheckpoints()
	if #checkpoints == 0 then
		warn("[Runner] No checkpoints found. Create workspace." .. CHECKPOINT_FOLDER_NAME .. " with Parts inside.")
		running = false
		return
	end

	local npcs = getNPCs()

	while running do
		local char = LocalPlayer.Character
		local hrp = char and getHRP(char)
		if not char or not hrp then
			task.wait(0.2)
			continue
		end

		lockModel(char, true)
		for _, npc in ipairs(npcs) do
			lockModel(npc, true)
		end

		for _, cp in ipairs(checkpoints) do
			if not running then break end
			if not cp or not cp.Parent then continue end

			-- Player tween
			local fromPos = hrp.Position
			local goalCF = cp.CFrame + PLAYER_OFFSET
			local duration = timeForDistance(fromPos, goalCF.Position)

			local t1 = tweenPartTo(hrp, goalCF, duration)

			-- NPC tweens
			local npcTweens = {}
			for _, npc in ipairs(npcs) do
				if npc.PrimaryPart and npc.PrimaryPart.Parent then
					local nFrom = npc.PrimaryPart.Position
					local nGoal = cp.CFrame + NPC_OFFSET
					local nDur = timeForDistance(nFrom, nGoal.Position)
					npcTweens[#npcTweens + 1] = tweenPartTo(npc.PrimaryPart, nGoal, nDur)
				end
			end

			-- Wait until player tween finishes (or you stop)
			local done = false
			if t1 then
				t1.Completed:Once(function() done = true end)
				while running and not done do
					task.wait(0.05)
				end
			else
				task.wait(0.3)
			end

			-- small pause at each checkpoint
			task.wait(0.15)
		end
	end

	stopAllTweensAndUnlock()
end

--// GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "CheckpointTweenGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = PlayerGui

local button = Instance.new("TextButton")
button.Size = UDim2.new(0, 210, 0, 50)
button.Position = UDim2.new(0, 20, 0, 20)
button.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
button.TextColor3 = Color3.new(1, 1, 1)
button.Font = Enum.Font.SourceSansBold
button.TextSize = 22
button.Text = "Start Checkpoint Tween"
button.Parent = screenGui

button.MouseButton1Click:Connect(function()
	running = not running

	if running then
		button.Text = "Stop Checkpoint Tween"
		if loopTask then
			task.cancel(loopTask)
			loopTask = nil
		end
		loopTask = task.spawn(runLoop)
	else
		button.Text = "Start Checkpoint Tween"
		if loopTask then
			task.cancel(loopTask)
			loopTask = nil
		end
		stopAllTweensAndUnlock()
	end
end)
